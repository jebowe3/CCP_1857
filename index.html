<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
  <title>USA_1857.tif</title>

  <!-- CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.css" />
  <!--for icon support-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.14.0/css/all.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.14.0/css/v4-shims.css">
  <!-- for icon markers -->
  <link rel="stylesheet" href="css/leaflet.extra-markers.min.css">

  <!-- JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.js"></script>
  <!--d3-fetch parsing module for requesting files into web application-->
  <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
  <!-- jquery -->
  <script src="https://code.jquery.com/jquery-3.2.0.min.js"></script>
  <!-- for icon markers -->
  <script src="js/leaflet.extra-markers.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    body,
    table,
    tr,
    td,
    th,
    div,
    h1,
    h2,
    input {
      font-family: "Calibri", "Trebuchet MS", "Ubuntu", Serif;
      font-size: 11pt;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    /* Set time slider styles */
    #slider {
      position: absolute;
      height: 26px;
      bottom: 0px;
      left: 125px;
      z-index: 1000;
      background-color: #FFFFFF;
      border-radius: 3px;
      box-shadow: 0px 0px 0px 2px rgba(0, 0, 0, 0.3);
    }

    /* Set temporal legend styles */
    .leaflet-legend {
      background-color: #FFFFFF;
      border-radius: 3px;
      box-shadow: 0px 0px 0px 2px rgba(0, 0, 0, 0.3);
      padding: 2px 2px 2px 2px;
      height: 100%;
      width: 100%;
      text-align: center;
    }

    /* Set the styles for the text span in the temporal legend */
    span.spanTxt {
      display: block;
      width: 100%;
      height: 100%;
      margin: 0 auto;
    }

    /* full size */
    .ctl {
      padding: 2px 10px 2px 10px;
      background: white;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      text-align: right;
    }

    .title {
      font-size: 18pt;
      font-weight: bold;
    }

    .src {
      font-size: 10pt;
    }
  </style>

</head>

<body>
  <!-- the map -->
  <div id="map"></div>

  <!-- ui slider -->
  <div id='slider' class='leaflet-control'>
    <!-- Use the first and last year of the time data as the min and max. Set the initial value as the first year. Set the steps at one year. -->
    <input type='range' min="1791" max="1925" value="1791" step="1" class="slider" />
  </div>
  <!-- end slider -->

  <!-- temporal legend -->
  <div id='temporal' class='leaflet-legend'>
    <span class="spanTxt"></span>
  </div>
  <!-- end temporal -->

  <script>
    /* **** Leaflet **** */

    //  .. CartoDB Positron Base Layer
    var cartodb = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
      minZoom: 2,
      maxZoom: 7
    });

    // Map
    var map = L.map('map', {
      center: [36.98497425987991, -97.43894489601635],
      zoom: 5,
      minZoom: 2,
      maxZoom: 7,
      layers: [cartodb]
    });

    // 1857 Map Tiles
    var lyr = L.tileLayer('CCP_1857_MapTiles/{z}/{x}/{y}.png', {
      tms: true,
      opacity: 1.0,
      attribution: "",
      minZoom: 2,
      maxZoom: 7
    }).addTo(map);

    // Title
    var title = L.control();
    title.onAdd = function(map) {
      this._div = L.DomUtil.create('div', 'ctl title');
      this.update();
      return this._div;
    };
    title.update = function(props) {
      this._div.innerHTML = "USA_1857.tif";
    };
    title.addTo(map);

    // Define an empty layer control
    var layerControl = L.control.layers(null, null, {
      collapsed: true,
    }).addTo(map); // Add it to the map

    // Define an empty layer group to store time-dependent events
    var events = L.layerGroup().addTo(map); // and add it to the map

    // Add the "events" layer group to the layer control
    layerControl.addOverlay(events, "Events");

    // Add a scale bar
    L.control.scale({
      position: 'bottomright' // Position the scale bar at the bottom-right corner
    }).addTo(map);

    // Add a function to style the markers by name
    function getColor(d) {
      return d === "Alexander Clark" ? 'red' :
        d === "Benjamin Mathews" ? 'blue' :
        d === "Boling Bowser" ? 'purple' :
        d === "Catherine Griffin Clark" ? 'yellow' :
        d === "Daniel Anderson" ? 'brown' :
        d === "Ellen Anderson nee Mathews" ? 'green' :
        d === "George Manly" ? 'orange' :
        d === "Hannah Virginia Mathews" ? 'orange-dark' :
        d === "John Hiner" ? 'blue-dark' :
        d === "Mahalia Sammons Motts" ? 'cyan' :
        d === "Mahalia Sammons Motts Lindsey" ? 'cyan' :
        d === "Mary A. Jeffers Cowan Hiner" ? 'violet' :
        d === "Minerva A. Barkshire Tutt" ? 'pink' :
        d === "Noah Tutt" ? 'green-dark' :
        d === "Rebecca Darnes Clark Howard" ? 'white' :
        d === "Susan V. Clark Holly" ? 'green-light' :
        d === "Thomas Cook Motts" ? 'black' :
        'blue';
    };

    // use D3 fetch to request data with async requests
    const lifeData = d3.json('data/life_points_1857.geojson');

    // use Promise to wait until data is all loaded
    Promise.all([lifeData]).then(drawMap);

    // function is called when Promise is fulfilled and data is ready
    function drawMap(data) {

      // define currentYear
      var currentYear = $('.slider').val();

      // pull out separate data arrays and assign to variables
      const lives = data[0];

      // create a layerGroup with the geojson data
      const lifePoints = L.geoJson(lives, {

        pointToLayer: function(feature, ll) {

          return L.marker(ll, {
            icon: L.ExtraMarkers.icon({
              icon: 'far fa-user',
              prefix: 'fa',
              markerColor: getColor(feature.properties.Name),
              iconColor: 'white'
            })
          })

        }, //end pointToLayer

        // On each marker...
        onEachFeature: function(feature, layer) {

          // define the layer feature properties
          var props = layer.feature.properties;

          // bind info to the layer features using popups
          layer.bindPopup("<h4 class=txt-bold>" + props.Name + ", " + props.location + ", " + props.range_date + "</h4><h5>Information:<br>" + props.info + "<br>Description:<br>" + props.description + "</h5>", {
            closeButton: false
          });
          layer.on('mouseover', function() { // On mouseover...
            layer.openPopup(); // open the popup
          });
          layer.on('mouseout', function() { // On mouseout...
            layer.closePopup(); // close the popup
          });

          // Define a variable for the property holding the starting year value
          var startYear = layer.feature.properties.start_date;
          // Define a variable for the property holding the ending year value
          var endYear = layer.feature.properties.end_date;
          // If the current year is greater than or equal to the starting year
          // and less than or equal to the ending year...
          if (startYear <= currentYear && currentYear <= endYear) {
            // add the layer to the map
            map.addLayer(layer);
          } else { // otherwise...
            layer.removeFrom(map); // remove it from the map
          }

        }, // end onEachFeature

      });

      sequenceUI(lifePoints); // Produces the time slider and sends the layer to it
      createTemporalLegend(currentYear); // Produces temporal legend upon map loading

    }; // end drawMap

    // Add a temporal legend in sync with the UI slider
    function createTemporalLegend(currentYear) {

      var temporalLegend = L.control({
        position: 'bottomleft' // place the temporal legend at bottom left corner
      });

      // when added to the map
      temporalLegend.onAdd = function(map) {

        var div = L.DomUtil.get("temporal"); // get the style settings

        // disable the mouse events
        L.DomEvent.addListener(div, 'mousedown', function(e) {
          L.DomEvent.stopPropagation(e);
        });

        return div; // return the style settings

      }

      $('#temporal span').html("Year: " + currentYear); // change grade value to that currently selected by UI slider

      temporalLegend.addTo(map); // add the temporal legend to the map

    }; // End createTemporalLegend function

    // add a UI slider
    function sequenceUI(lifePoints) {

      // create Leaflet control for the slider
      var sliderControl = L.control({
        position: 'bottomleft',
        follow: true
      });

      // add controls to the slider
      sliderControl.onAdd = function(map) {

        var controls = L.DomUtil.get("slider"); // get the style settings

        // disable the mouse events and map dragging on mousedown
        L.DomEvent.addListener(controls, 'mousedown', function(e) {
          L.DomEvent.stopPropagation(e);
          map.dragging.disable();
        });

        // re-enable map dragging on mouseout
        L.DomEvent.addListener(slider, "mouseout", function(e) {
          map.dragging.enable();
        });

        return controls; // return the style settings

      }

      // add the control to the map
      sliderControl.addTo(map);

      $('.slider') // select the slider
        .on('input change', function() { // if any change is detected...
          var currentYear = $(this).val(); // identifies the year selected
          createTemporalLegend(currentYear); // run this function
          updateFeatures(lifePoints, currentYear); // run this function
        });

    }; // End sequenceUI function

    // Define updateFeatures function
    function updateFeatures(lifePoints, currentYear) {

      // On each point...
      lifePoints.eachLayer(function(layer) {

        // Define a variable for the property holding the starting year value
        var startYear = layer.feature.properties.start_date;
        // Define a variable for the property holding the ending year value
        var endYear = layer.feature.properties.end_date;
        // If the current year is greater than or equal to the starting year
        // and less than or equal to the ending year...
        if (startYear <= currentYear && currentYear <= endYear) {
          // add the layer to the layer group named "events"
          events.addLayer(layer);
        };

      });
      // For each layer in the "events" layer group...
      events.eachLayer(function (layer) {
        var startYear = layer.feature.properties.start_date;
        var endYear = layer.feature.properties.end_date;
        // if the selected year is less than the start year or
        // greater than the end year,
        if (currentYear < startYear || currentYear > endYear){
          // remove the layer from the "events" layer group
    			events.removeLayer(layer)
    		}
      });

    }; // End updateFeatures
  </script>

</body>

</html>
